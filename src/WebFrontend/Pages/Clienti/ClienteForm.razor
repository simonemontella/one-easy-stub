@page "/clienti/create"
@page "/clienti/{id:int}/edit"
@using global::Shared.DTO
@inject IClienteApiService ClienteService
@inject NavigationManager Navigation

<div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
	<div style="max-width: 600px; margin: 0 auto;">
		<h1 class="text-4xl font-bold text-gray-900 mb-8">@(Id > 0 ? "Modifica Cliente" : "Nuovo Cliente")</h1>

		@if (!string.IsNullOrEmpty(errorMessage)) {
			<div class="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded flex justify-between items-start">
				<p class="text-red-600 text-sm">@errorMessage</p>
				<button @onclick="() => errorMessage = null" class="text-red-600 hover:text-red-800">✕</button>
			</div>
		}

		<div class="bg-white rounded shadow p-6">
			<form @onsubmit="HandleSubmit">
				<div class="mb-6">
					<label class="block text-sm font-semibold text-gray-700 mb-2">Ragione Sociale *</label>
					<input type="text" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 transition" @bind="formData.RagioneSociale" required />
				</div>

				<div class="mb-6">
					<label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
					<input type="email" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 transition" @bind="formData.Email" required />
				</div>

				<div class="mb-6">
					<label class="block text-sm font-semibold text-gray-700 mb-2">Telefono *</label>
					<input type="tel" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 transition" @bind="formData.Telefono" required />
				</div>

				<div class="mb-6">
					<label class="block text-sm font-semibold text-gray-700 mb-2">Indirizzo *</label>
					<input type="text" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 transition" @bind="formData.Indirizzo" required />
				</div>

				<div class="grid grid-cols-2 gap-6 mb-6">
					<div>
						<label class="block text-sm font-semibold text-gray-700 mb-2">Città *</label>
						<input type="text" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 transition" @bind="formData.Citta" required />
					</div>
					<div>
						<label class="block text-sm font-semibold text-gray-700 mb-2">CAP *</label>
						<input type="text" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 transition" @bind="formData.Cap" maxlength="5" required />
					</div>
				</div>

				<div class="mb-8">
					<label class="block text-sm font-semibold text-gray-700 mb-2">Provincia *</label>
					<input type="text" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 transition" @bind="formData.Provincia" maxlength="2" required />
				</div>

				<div class="flex gap-3">
					<button type="submit" class="px-6 py-2 bg-primary text-white font-semibold rounded hover:bg-primary-dark transition" disabled="@isSubmitting">
						@(Id > 0 ? "Aggiorna" : "Crea")
					</button>
					<a href="/clienti" class="px-6 py-2 text-gray-700 border border-gray-300 font-semibold rounded hover:bg-gray-50 transition">Annulla</a>
				</div>
			</form>
		</div>
	</div>
</div>

@code {
	[Parameter]
	public int Id { get; set; } = 0;

	private CreateClienteDTO formData = new();
	private bool isSubmitting = false;
	private string? errorMessage;

	protected override async Task OnInitializedAsync() {
		if (Id > 0) {
			try {
				var cliente = await ClienteService.GetByIdAsync(Id);
				if (cliente != null) {
					formData = new CreateClienteDTO {
						RagioneSociale = cliente.RagioneSociale,
						Email = cliente.Email,
						Telefono = cliente.Telefono,
						Indirizzo = cliente.Indirizzo,
						Citta = cliente.Citta,
						Cap = cliente.Cap,
						Provincia = cliente.Provincia
					};
				} else {
					errorMessage = "Cliente non trovato";
				}
			} catch (Exception ex) {
				errorMessage = $"Errore nel caricamento del cliente: {ex.Message}";
			}
		}
	}

	private async Task HandleSubmit() {
		if (isSubmitting)
			return;

		try {
			isSubmitting = true;
			errorMessage = null;

			if (Id > 0) {
				var updateDto = new UpdateClienteDTO {
					RagioneSociale = formData.RagioneSociale,
					Email = formData.Email,
					Telefono = formData.Telefono,
					Indirizzo = formData.Indirizzo,
					Citta = formData.Citta,
					Cap = formData.Cap,
					Provincia = formData.Provincia
				};
				await ClienteService.UpdateAsync(Id, updateDto);
			} else {
				await ClienteService.CreateAsync(formData);
			}

			Navigation.NavigateTo("/clienti");
		} catch (Exception ex) {
			errorMessage = $"Errore: {ex.Message}";
		} finally {
			isSubmitting = false;
		}
	}
}

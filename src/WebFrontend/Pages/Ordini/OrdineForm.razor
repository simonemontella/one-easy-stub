@page "/ordini/create"
@using Shared.DTO
@using Shared.Models
@inject IOrdineApiService OrdineService
@inject IClienteApiService ClienteService
@inject NavigationManager Navigation

<div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
	<div style="max-width: 800px; margin: 0 auto;">
		<h1 class="text-4xl font-bold text-gray-900 mb-8">Nuovo Ordine</h1>

		@if (!string.IsNullOrEmpty(errorMessage)) {
			<div class="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded flex justify-between items-start">
				<p class="text-red-600 text-sm">@errorMessage</p>
				<button @onclick="() => errorMessage = null" class="text-red-600 hover:text-red-800">✕</button>
			</div>
		}

		<div class="bg-white rounded shadow p-6 mb-6">
			<form @onsubmit="HandleSubmit">
				<div class="mb-6">
					<label class="block text-sm font-semibold text-gray-700 mb-2">Cliente *</label>
					@if (isLoadingClienti) {
						<div class="flex items-center">
							<div class="w-5 h-5 border-2 border-gray-300 border-t-primary rounded-full animate-spin"></div>
						</div>
					} else {
						<select class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 transition" @bind="formData.ClienteId" required>
							<option value="0">Seleziona un cliente...</option>
							@if (clienti != null) {
								@foreach (var cliente in clienti) {
									<option value="@cliente.Id">@cliente.RagioneSociale</option>
								}
							}
						</select>
					}
				</div>

				<div class="flex gap-3">
					<button type="submit" class="px-6 py-2 bg-primary text-white font-semibold rounded hover:bg-primary-dark transition" disabled="@isSubmitting">Crea</button>
					<a href="/ordini" class="px-6 py-2 text-gray-700 border border-gray-300 font-semibold rounded hover:bg-gray-50 transition">Annulla</a>
				</div>
			</form>
		</div>

		<!-- Sezione Linee Ordine -->
		<div class="bg-white rounded shadow p-6">
			<div class="flex justify-between items-center mb-6">
				<h2 class="text-lg font-bold text-gray-900">Linee Ordine (@lineeOrdine.Count)</h2>
				<button type="button" @onclick="ToggleNewLineForm" class="px-4 py-2 bg-primary text-white font-semibold rounded hover:bg-primary-dark transition">
					@if (showNewLineForm) { <span>✕ Annulla</span> } else { <span>+ Nuova Linea</span> }
				</button>
			</div>

			@if (showNewLineForm) {
				<div class="mb-6 bg-gray-50 p-4 rounded border border-gray-200">
					<h3 class="text-sm font-semibold text-gray-900 mb-4">Aggiungi Linea Ordine</h3>
					<div class="grid grid-cols-2 gap-4 mb-4">
						<div>
							<label class="block text-sm font-semibold text-gray-700 mb-2">Descrizione *</label>
							<input type="text" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20" @bind="newLinea.Prodotto" placeholder="Descrizione prodotto" />
						</div>
						<div>
							<label class="block text-sm font-semibold text-gray-700 mb-2">Quantità *</label>
							<input type="number" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20" @bind="newLinea.Quantita" min="1" />
						</div>
						<div>
							<label class="block text-sm font-semibold text-gray-700 mb-2">Prezzo Unitario *</label>
							<input type="number" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20" @bind="newLinea.PrezzoUnitario" min="0" step="0.01" />
						</div>
						<div>
							<label class="block text-sm font-semibold text-gray-700 mb-2">Totale</label>
							<input type="text" class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100 cursor-not-allowed" value="@(newLinea.Quantita * newLinea.PrezzoUnitario).ToString("C")" disabled />
						</div>
					</div>
					<div class="flex gap-2">
						<button type="button" @onclick="AddLinea" class="px-4 py-2 bg-primary text-white font-semibold rounded hover:bg-primary-dark transition">
							Aggiungi Linea
						</button>
						<button type="button" @onclick="ToggleNewLineForm" class="px-4 py-2 text-gray-700 border border-gray-300 font-semibold rounded hover:bg-gray-50 transition">
							Annulla
						</button>
					</div>
				</div>
			}

			<!-- Tabella Linee -->
			@if (lineeOrdine.Count == 0) {
				<p class="text-gray-600">Nessuna linea aggiunta. Aggiungine una per iniziare.</p>
			} else {
				<div class="overflow-x-auto">
					<table class="w-full">
						<thead class="bg-gray-100 border-b border-gray-200">
							<tr>
								<th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Descrizione</th>
								<th class="px-6 py-3 text-center text-sm font-semibold text-gray-700">Quantità</th>
								<th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Prezzo</th>
								<th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Totale</th>
								<th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Azioni</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-gray-200">
							@foreach (var (linea, index) in lineeOrdine.Select((l, i) => (l, i))) {
								<tr class="hover:bg-gray-50 transition">
									<td class="px-6 py-4 text-sm text-gray-900">@linea.Prodotto</td>
									<td class="px-6 py-4 text-sm text-center text-gray-600">@linea.Quantita</td>
									<td class="px-6 py-4 text-sm text-right text-gray-600">@linea.PrezzoUnitario.ToString("C")</td>
									<td class="px-6 py-4 text-sm text-right font-semibold text-gray-900">@linea.Subtotale.ToString("C")</td>
									<td class="px-6 py-4 text-sm text-right">
										<button type="button" @onclick="() => RemoveLinea(index)" class="px-3 py-1 text-sm bg-red-50 text-red-600 rounded hover:bg-red-100 transition">Rimuovi</button>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			}

			<!-- Totale -->
			<div class="mt-6 border-t pt-6">
				<div class="flex justify-end">
					<div class="text-right">
						<p class="text-gray-600 mb-2">Totale Ordine</p>
						<p class="text-3xl font-bold text-primary">@CalculateTotale().ToString("C")</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	private CreateOrdineDTO formData = new();
	private List<ClienteListDTO>? clienti;
	private List<LineaOrdine> lineeOrdine = new();
	private LineaOrdine newLinea = new();
	private bool isSubmitting = false;
	private bool isLoadingClienti = true;
	private bool showNewLineForm = false;
	private string? errorMessage;

	protected override async Task OnInitializedAsync() {
		await LoadClienti();
	}

	private async Task LoadClienti() {
		try {
			isLoadingClienti = true;
			clienti = await ClienteService.GetAllAsync();
		} catch (Exception ex) {
			errorMessage = $"Errore nel caricamento dei clienti: {ex.Message}";
		} finally {
			isLoadingClienti = false;
		}
	}

	private void ToggleNewLineForm() {
		showNewLineForm = !showNewLineForm;
		if (!showNewLineForm) {
			newLinea = new();
		}
	}

	private void AddLinea() {
		if (string.IsNullOrWhiteSpace(newLinea.Prodotto)) {
			errorMessage = "Inserisci la descrizione della linea";
			return;
		}

		if (newLinea.Quantita <= 0) {
			errorMessage = "La quantità deve essere maggiore di 0";
			return;
		}

		if (newLinea.PrezzoUnitario < 0) {
			errorMessage = "Il prezzo non può essere negativo";
			return;
		}

		newLinea.Subtotale = newLinea.Quantita * newLinea.PrezzoUnitario;
		lineeOrdine.Add(new LineaOrdine {
			Prodotto = newLinea.Prodotto,
			Quantita = newLinea.Quantita,
			PrezzoUnitario = newLinea.PrezzoUnitario,
			Subtotale = newLinea.Subtotale
		});

		newLinea = new();
		showNewLineForm = false;
		errorMessage = null;
	}

	private void RemoveLinea(int index) {
		if (index >= 0 && index < lineeOrdine.Count) {
			lineeOrdine.RemoveAt(index);
		}
	}

	private float CalculateTotale() {
		return lineeOrdine.Sum(l => l.Subtotale);
	}

	private async Task HandleSubmit() {
		if (isSubmitting)
			return;

		try {
			isSubmitting = true;
			errorMessage = null;

			if (formData.ClienteId <= 0) {
				errorMessage = "Seleziona un cliente";
				return;
			}

			formData.Data = DateTime.Now;
			formData.Totale = CalculateTotale();
			formData.Linee = lineeOrdine.Count > 0 ? lineeOrdine : null;

			await OrdineService.CreateAsync(formData);
			Navigation.NavigateTo("/ordini");
		} catch (Exception ex) {
			errorMessage = $"Errore: {ex.Message}";
		} finally {
			isSubmitting = false;
		}
	}
}
